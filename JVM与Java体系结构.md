# JVM与Java体系结构

## Java及JVM简介

- 随着Java7的正式发布,Java虚拟机的设计者们通过JSR-292规范基本实现在Java虚拟机平台上运行非Java语言编写的程序.
- Java虚拟机根本不关心运行在其内部的程序到底是使用何种语言编写的,它只关心字节码文件,也就是说Java虚拟机拥有语言无关性,并不会单纯地于Java语言终身绑定,只要其他语言的编译结果满足并包含Java虚拟机的内部指令集,符号表以及其他的辅助信息,他就是一个有效的字节码文件,就能够呗虚拟机所识别并装载运行
- 我们平时说的Java字节码,指的是用Java语言编译成的字节码.准确的说任何能在jvm平台上执行的字节码格式都是一样的.所以应该统称为:jvm字节码
- 不同的编译器,可以编译出相同的字节码文件,字节码文件也可以在不同的JVM上运行
- Java虚拟机与Java语言并没有必然的联系,它只与特定的二进制文件格式--class文件格式所关联,class文件中包含了java虚拟机指令集(或者称为字节码,Bytecodes)和符号表,还有一些其他辅助讯息.

## 虚拟机与Java虚拟机

### 虚拟机

- 所谓虚拟机（Virtual Machine），就是一天虚拟的计算机，它是一款软件，用来执行一系列虚拟计算机指令。大体上，虚拟机可以分为**系统虚拟机**和**程序虚拟机**

  - 大名鼎鼎的的Visual Box，VMware就属于系统虚拟机，他们完全是对物理计算机的仿真，提供了一个可运行完整操作系统的软件平台
- 程序虚拟机的典型代表就是Java虚拟机，它专门为执行单个计算机程序而设计，在Java虚拟机中执行的指令我们称为Java字节码指令。
- 无论是系统虚拟机还是程序虚拟机，在上面运行的软件都被限制于虚拟机提供的资源中。

### Java虚拟机

- Java虚拟机是一台执行Java字节码的虚拟计算机，它拥有独立的运行机制，其运行的Java字节码也未必由Java语言编译而成。

- JVM平台的各种语言可以共享Java虚拟机带来的跨平台性，优秀的垃圾回收器，以及可靠的即时编译器。

- Java技术的核心就是Java虚拟机，因为所有的Java程序都运行在Java虚拟机内部。

- **Java虚拟机就是二进制字节码的运行环境**，负责装载字节码到其内部，解释/编译为对应平台上的机器指令执行。每一条Java指令，Java虚拟机规范中都有详细定义，如怎么取操作数，怎么处理操作数，处理结果放在哪里。

- Java虚拟机的特点

  - 一次编译，到处运行
  - 自动内存管理
  - 自动垃圾回收功能

- JVM的位置

  ![](https://dengjunbo-blog.oss-cn-beijing.aliyuncs.com/20210121155721.png)

  ![](https://dengjunbo-blog.oss-cn-beijing.aliyuncs.com/20210121160157.png)

  


## JVM的整体结构

- HotSpot VM是目前市面是高性能虚拟机的代表作之一。

- 它采用了解释器与即时编译器并存的架构。

- 在今天，Java程序的运行性能早已经脱胎换骨，已经达到可以和Ｃ／C＋＋程序一较高下的地步了。

  ![](https://dengjunbo-blog.oss-cn-beijing.aliyuncs.com/20210121160631.png)

## Java代码的执行流程

![](https://dengjunbo-blog.oss-cn-beijing.aliyuncs.com/20210121160814.png)

## JVM的架构模型

Java编译器输入的指令流基本上是一种基于栈的指令集架构,另外一种指令集架构则是基于寄存器的指令集架构

具体来说,这两种架构之间的区别:

- 基于栈式架构的特点:
  - 设计和实现更简单,适用于资源受限的系统 
  - 避开了寄存器的分配难题:使用零地址指令方式分配.
  - 指令流中的指令大部分是零地址指令,其执行过程依赖于操作栈,指令集更小,编译器更容易实现.
  - 不需要硬件支持,可移植性更好,更好实现跨平台
- 基于寄存器架构的特点
  - 典型的应用是x86的二进制指令集:比如传统的PC以及Android的Davlik虚拟机.
  - 指令集架构则完全依赖硬件,可移植性差
  - 性能优秀和执行更高效
  - 花费更少的指令去完成一项操作
  - 在大部分情况下,基于寄存器架构的指令集往往都是以一地址指令,二地址指令和三地址指令为主,而基于栈式架构的指令集确实义零地址指令为主

由于跨平台的设计,Java的指令都是根据栈来设计的.不同平台CPU架构不同,所以不能设计为基于寄存器 的.优点是跨平台,指令集小,编译器容易实现,实现同样的功能需要更多的指令

## JVM的生命周期

### 虚拟机的启动

Java虚拟机的启动是通过引导类加载器(bootstrap class loader)创建一个初始类(initial class)来完成的,这个类是由虚拟机的具体实现指定的.

### 虚拟机的执行

- 一个运行中的Java虚拟机有着一个清晰的任务:执行Java程序.
- 程序开始执行时他才执行,程序结束时他就停止.
- 执行一个所谓的Java程序的时候,真真正正在执行的是一个叫做Java虚拟机的进程

### 虚拟机的退出

有如下几种情况:

- 程序正常的执行结束
- 程序在执行过程中遇到了异常或错误而异常终止
- 由于操作系统出现错误而导致java虚拟机进程终止
- 某线程调用Runtime类或System类的exit方法,或Runtime类的halt方法,并且Java安全管理器也允许这次的exit或halt操作
- 除此之外,JNI(Java Native Interface)规范描述了用JNI Invocation API来加载或卸载Java虚拟机时，Java虚拟机的退出情况．

## 

